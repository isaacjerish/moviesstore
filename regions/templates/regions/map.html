{% extends 'base.html' %}
{% block content %}
{% load static %}

<div class="p-3">
  <div class="container">
    <div class="row mt-3">
      <div class="col mx-auto mb-3">
        <h2>Local Popularity Map</h2>
        <hr />
        <p class="text-muted">Click on any state to see trending movies in that region</p>
      </div>
    </div>

    <div class="row">
      <!-- Map Container -->
      <div class="col-lg-8">
        <div class="card">
          <div class="card-body p-0">
            <div id="map" style="height: 500px; width: 100%;"></div>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0" id="sidebar-title">Select a State</h5>
          </div>
          <div class="card-body" id="sidebar-content">
            <p class="text-muted">Click on a state on the map to see trending movies in that region.</p>
          </div>
        </div>

        <!-- Global Trending -->
        <div class="card mt-3">
          <div class="card-header">
            <h6 class="mb-0">Globally Trending</h6>
          </div>
          <div class="card-body" id="global-trending">
            <div class="text-center">
              <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2 text-muted">Loading trending movies...</p>
            </div>
          </div>
        </div>

        <!-- Compare States -->
        <div class="card mt-3">
          <div class="card-header">
            <h6 class="mb-0">Compare States</h6>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="state1-select" class="form-label">State 1:</label>
              <select class="form-select form-select-sm" id="state1-select">
                <option value="">Select first state</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="state2-select" class="form-label">State 2:</label>
              <select class="form-select form-select-sm" id="state2-select">
                <option value="">Select second state</option>
              </select>
            </div>
            <button class="btn btn-primary btn-sm w-100" id="compare-btn" disabled>
              Compare States
            </button>
            <div id="compare-results" class="mt-3" style="display: none;">
              <!-- Comparison results will be displayed here -->
            </div>
          </div>
        </div>

        <!-- Personal & User Comparisons -->
        <div class="card mt-3">
          <div class="card-header">
            <h6 class="mb-0">Personal & User Comparisons</h6>
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <button class="btn btn-outline-primary btn-sm" id="personal-btn">
                <i class="fas fa-user"></i> My Purchases vs My State
              </button>
              <button class="btn btn-outline-secondary btn-sm" id="other-users-btn">
                <i class="fas fa-users"></i> Users from Selected State
              </button>
              <button class="btn btn-outline-info btn-sm" id="my-purchases-btn">
                <i class="fas fa-shopping-cart"></i> My Recent Purchases
              </button>
            </div>
            <div id="personal-results" class="mt-3" style="display: none;">
              <!-- Personal comparison results will be displayed here -->
            </div>
            <div id="other-users-results" class="mt-3" style="display: none;">
              <!-- Other users results will be displayed here -->
            </div>
            <div id="my-purchases-results" class="mt-3" style="display: none;">
              <!-- My purchases results will be displayed here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- US States GeoJSON -->
<script src="https://unpkg.com/us-atlas@3/states-10m.json" type="application/json" id="states-geojson"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map centered on US
    const map = L.map('map').setView([39.8283, -98.5795], 4);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    let statesLayer;
    let selectedStateId = null;
    let currentSelectedState = null;
    
    // Load states data
    fetch('/regions/api/states/')
        .then(response => response.json())
        .then(data => {
            loadStatesData(data.states);
            loadGlobalTrending();
        })
        .catch(error => {
            console.error('Error loading states:', error);
            document.getElementById('sidebar-content').innerHTML = 
                '<div class="alert alert-danger">Error loading map data. Please refresh the page.</div>';
        });
    
    function loadStatesData(states) {
        // Create markers for each state
        states.forEach(state => {
            const marker = L.marker([state.center_lat, state.center_lng])
                .addTo(map)
                .bindPopup(`
                    <div class="text-center">
                        <h6>${state.name}</h6>
                        <button class="btn btn-sm btn-primary" onclick="selectState(${state.id})">
                            View Trending Movies
                        </button>
                    </div>
                `);
            
            // Store state data on marker
            marker.stateData = state;
        });
    }
    
    function loadGlobalTrending() {
        fetch('/regions/api/trending/')
            .then(response => response.json())
            .then(data => {
                displayGlobalTrending(data.movies);
            })
            .catch(error => {
                console.error('Error loading global trending:', error);
                document.getElementById('global-trending').innerHTML = 
                    '<div class="alert alert-warning">Unable to load trending data</div>';
            });
    }
    
    function displayGlobalTrending(movies) {
        const container = document.getElementById('global-trending');
        
        if (movies.length === 0) {
            container.innerHTML = '<p class="text-muted">No trending data available</p>';
            return;
        }
        
        let html = '<div class="list-group list-group-flush">';
        movies.slice(0, 5).forEach(movie => {
            html += `
                <div class="list-group-item px-0 py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${movie.name}</h6>
                            <small class="text-muted">${movie.genre} • ${movie.rating}</small>
                        </div>
                        <div class="text-end">
                            <small class="text-success">${movie.total_purchases} purchases</small><br>
                            <small class="text-muted">${movie.state_count} states</small>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }
    
    function selectState(stateId) {
        selectedStateId = stateId;
        currentSelectedState = states.find(s => s.id === stateId);
        
        // Update sidebar title
        document.getElementById('sidebar-title').textContent = `Trending in ${currentSelectedState.name}`;
        
        // Show loading
        document.getElementById('sidebar-content').innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading movies...</p>
            </div>
        `;
        
        // Load state movies
        fetch(`/regions/api/state/${stateId}/movies/`)
            .then(response => response.json())
            .then(data => {
                displayStateMovies(data.movies, data.state);
            })
            .catch(error => {
                console.error('Error loading state movies:', error);
                document.getElementById('sidebar-content').innerHTML = 
                    '<div class="alert alert-danger">Error loading movies for this state</div>';
            });
    }
    
    function displayStateMovies(movies, state) {
        const container = document.getElementById('sidebar-content');
        
        if (movies.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    No movie data available for ${state.name}
                </div>
            `;
            return;
        }
        
        let html = `
            <div class="mb-3">
                <small class="text-muted">Top ${movies.length} trending movies in ${state.name}</small>
            </div>
            <div class="list-group list-group-flush">
        `;
        
        movies.forEach((movie, index) => {
            html += `
                <div class="list-group-item px-0 py-2">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <span class="badge bg-primary">${index + 1}</span>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${movie.name}</h6>
                            <small class="text-muted">${movie.genre} • ${movie.rating}</small>
                        </div>
                        <div class="text-end">
                            <small class="text-success">${movie.purchase_count} purchases</small><br>
                            <small class="text-muted">${movie.view_count} views</small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    // Make selectState globally available
    window.selectState = selectState;
    
    // Store states data globally for popup access
    let states = [];
    fetch('/regions/api/states/')
        .then(response => response.json())
        .then(data => {
            states = data.states;
            populateCompareDropdowns(data.states);
        });
    
    function populateCompareDropdowns(states) {
        const state1Select = document.getElementById('state1-select');
        const state2Select = document.getElementById('state2-select');
        
        states.forEach(state => {
            const option1 = new Option(state.name, state.id);
            const option2 = new Option(state.name, state.id);
            state1Select.add(option1);
            state2Select.add(option2);
        });
        
        // Enable compare button when both states are selected
        state1Select.addEventListener('change', updateCompareButton);
        state2Select.addEventListener('change', updateCompareButton);
    }
    
    function updateCompareButton() {
        const state1 = document.getElementById('state1-select').value;
        const state2 = document.getElementById('state2-select').value;
        const compareBtn = document.getElementById('compare-btn');
        
        if (state1 && state2 && state1 !== state2) {
            compareBtn.disabled = false;
            compareBtn.addEventListener('click', compareStates);
        } else {
            compareBtn.disabled = true;
        }
    }
    
    function compareStates() {
        const state1 = document.getElementById('state1-select').value;
        const state2 = document.getElementById('state2-select').value;
        const resultsDiv = document.getElementById('compare-results');
        
        if (!state1 || !state2 || state1 === state2) {
            return;
        }
        
        // Show loading
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Comparing states...</p>
            </div>
        `;
        
        // Fetch comparison data
        fetch(`/regions/api/compare/?state1=${state1}&state2=${state2}`)
            .then(response => response.json())
            .then(data => {
                displayComparison(data);
            })
            .catch(error => {
                console.error('Error comparing states:', error);
                resultsDiv.innerHTML = '<div class="alert alert-danger">Error comparing states</div>';
            });
    }
    
    function displayComparison(data) {
        const resultsDiv = document.getElementById('compare-results');
        
        let html = `
            <div class="row">
                <div class="col-6">
                    <h6 class="text-center">${data.state1.name}</h6>
                    <div class="list-group list-group-flush">
        `;
        
        data.state1.movies.slice(0, 5).forEach((movie, index) => {
            html += `
                <div class="list-group-item px-0 py-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="fw-bold">${index + 1}. ${movie.name}</small><br>
                            <small class="text-muted">${movie.genre}</small>
                        </div>
                        <div class="text-end">
                            <small class="text-success">${movie.purchase_count} purchases</small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
                <div class="col-6">
                    <h6 class="text-center">${data.state2.name}</h6>
                    <div class="list-group list-group-flush">
        `;
        
        data.state2.movies.slice(0, 5).forEach((movie, index) => {
            html += `
                <div class="list-group-item px-0 py-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="fw-bold">${index + 1}. ${movie.name}</small><br>
                            <small class="text-muted">${movie.genre}</small>
                        </div>
                        <div class="text-end">
                            <small class="text-success">${movie.purchase_count} purchases</small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
        
        resultsDiv.innerHTML = html;
    }
    
    // Personal & User Comparison Event Listeners
    document.getElementById('personal-btn').addEventListener('click', function() {
        hideAllResults();
        showPersonalComparison();
    });
    
    document.getElementById('other-users-btn').addEventListener('click', function() {
        hideAllResults();
        showOtherUsers();
    });
    
    document.getElementById('my-purchases-btn').addEventListener('click', function() {
        hideAllResults();
        showMyPurchases();
    });
    
    function hideAllResults() {
        document.getElementById('personal-results').style.display = 'none';
        document.getElementById('other-users-results').style.display = 'none';
        document.getElementById('my-purchases-results').style.display = 'none';
    }
    
    function showPersonalComparison() {
        const resultsDiv = document.getElementById('personal-results');
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading your data...</p>
            </div>
        `;
        
        fetch('/regions/api/compare-personal/')
            .then(response => response.json())
            .then(data => {
                displayPersonalComparison(data);
            })
            .catch(error => {
                console.error('Error loading personal comparison:', error);
                resultsDiv.innerHTML = '<div class="alert alert-danger">Error loading your data</div>';
            });
    }
    
    function showOtherUsers() {
        const resultsDiv = document.getElementById('other-users-results');
        resultsDiv.style.display = 'block';
        
        // Check if a state is selected
        if (!currentSelectedState) {
            resultsDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Please select a state first to see users from that region.
                </div>
            `;
            return;
        }
        
        resultsDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading users from ${currentSelectedState.name}...</p>
            </div>
        `;
        
        fetch(`/regions/api/other-users/?state_id=${currentSelectedState.id}`)
            .then(response => response.json())
            .then(data => {
                displayOtherUsers(data);
            })
            .catch(error => {
                console.error('Error loading other users:', error);
                resultsDiv.innerHTML = '<div class="alert alert-danger">Error loading other users</div>';
            });
    }
    
    function showMyPurchases() {
        const resultsDiv = document.getElementById('my-purchases-results');
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = `
            <div class="text-center">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading your purchases...</p>
            </div>
        `;
        
        fetch('/regions/api/personal/')
            .then(response => response.json())
            .then(data => {
                displayMyPurchases(data);
            })
            .catch(error => {
                console.error('Error loading personal purchases:', error);
                resultsDiv.innerHTML = '<div class="alert alert-danger">Error loading your purchases</div>';
            });
    }
    
    function displayPersonalComparison(data) {
        const resultsDiv = document.getElementById('personal-results');
        
        let html = `
            <div class="row">
                <div class="col-6">
                    <h6 class="text-center">Your Purchases</h6>
                    <div class="list-group list-group-flush">
        `;
        
        if (data.personal.movies.length === 0) {
            html += '<div class="text-muted text-center">No purchases yet</div>';
        } else {
            data.personal.movies.slice(0, 5).forEach((movie, index) => {
                html += `
                    <div class="list-group-item px-0 py-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="fw-bold">${index + 1}. ${movie.name}</small><br>
                                <small class="text-muted">${movie.genre}</small>
                            </div>
                            <div class="text-end">
                                <small class="text-success">${movie.total_quantity} bought</small>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        html += `
                    </div>
                </div>
                <div class="col-6">
                    <h6 class="text-center">${data.state.name} Trending</h6>
                    <div class="list-group list-group-flush">
        `;
        
        data.state.movies.slice(0, 5).forEach((movie, index) => {
            html += `
                <div class="list-group-item px-0 py-1">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="fw-bold">${index + 1}. ${movie.name}</small><br>
                            <small class="text-muted">${movie.genre}</small>
                        </div>
                        <div class="text-end">
                            <small class="text-success">${movie.purchase_count} purchases</small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
        
        resultsDiv.innerHTML = html;
    }
    
    function displayOtherUsers(data) {
        const resultsDiv = document.getElementById('other-users-results');
        
        if (data.users.length === 0) {
            resultsDiv.innerHTML = `
                <div class="text-muted text-center">
                    <i class="fas fa-users"></i><br>
                    No users with purchases found in ${data.state_name}
                </div>
            `;
            return;
        }
        
        let html = `
            <div class="mb-3">
                <h6 class="text-center">Users from ${data.state_name}</h6>
                <small class="text-muted text-center d-block">${data.total_users} users with purchases</small>
            </div>
            <div class="accordion" id="usersAccordion">
        `;
        
        data.users.forEach((user, userIndex) => {
            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading${userIndex}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                data-bs-target="#collapse${userIndex}" aria-expanded="false" aria-controls="collapse${userIndex}">
                            <div class="d-flex justify-content-between align-items-center w-100 me-3">
                                <span>${user.username}</span>
                                <span class="badge bg-primary">${user.purchases.length} movies</span>
                            </div>
                        </button>
                    </h2>
                    <div id="collapse${userIndex}" class="accordion-collapse collapse" 
                         aria-labelledby="heading${userIndex}" data-bs-parent="#usersAccordion">
                        <div class="accordion-body">
                            <div class="list-group list-group-flush">
            `;
            
            user.purchases.forEach((movie, index) => {
                html += `
                    <div class="list-group-item px-0 py-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="fw-bold">${index + 1}. ${movie.name}</small><br>
                                <small class="text-muted">${movie.genre} • ${movie.rating}</small>
                            </div>
                            <div class="text-end">
                                <small class="text-success">${movie.total_quantity} bought</small><br>
                                <small class="text-muted">$${movie.total_spent} spent</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        resultsDiv.innerHTML = html;
    }
    
    function displayMyPurchases(data) {
        const resultsDiv = document.getElementById('my-purchases-results');
        
        if (data.user.purchases.length === 0) {
            resultsDiv.innerHTML = '<div class="text-muted text-center">No purchases yet. Start shopping!</div>';
            return;
        }
        
        let html = `
            <h6 class="text-center">Your Recent Purchases</h6>
            <div class="list-group list-group-flush">
        `;
        
        data.user.purchases.forEach((movie, index) => {
            html += `
                <div class="list-group-item px-0 py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${movie.name}</h6>
                            <small class="text-muted">${movie.genre} • ${movie.rating}</small>
                        </div>
                        <div class="text-end">
                            <small class="text-success">${movie.total_quantity} bought</small><br>
                            <small class="text-muted">$${movie.total_spent} spent</small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        resultsDiv.innerHTML = html;
    }
});
</script>

<style>
#map {
    border-radius: 0.375rem;
}

.leaflet-popup-content {
    margin: 8px 12px;
}

.leaflet-popup-content h6 {
    margin-bottom: 8px;
}

.list-group-item {
    border-left: none;
    border-right: none;
}

.list-group-item:first-child {
    border-top: none;
}

.list-group-item:last-child {
    border-bottom: none;
}
</style>

{% endblock content %}
